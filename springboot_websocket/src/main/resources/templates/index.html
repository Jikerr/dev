<!DOCTYPE html>
<html lang="zh" class="no-js demo-1" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<script th:src="@{js/jquery.min.js}"></script>
		<script th:src="@{js/Helper.js}"></script>
		<script th:src="@{js/keyboard.js}"></script>
		<script th:src="@{js/const.js}"></script>
		<script th:src="@{js/level.js}"></script>
		<script th:src="@{js/crackAnimation.js}"></script>
		<script th:src="@{js/prop.js}"></script>
		<script th:src="@{js/bullet.js}"></script>
		<script th:src="@{js/tank.js}"></script>
		<script th:src="@{js/num.js}"></script>
		<script th:src="@{js/menu.js}"></script>
		<script th:src="@{js/map.js}"></script>
		<script th:src="@{js/Collision.js}"></script>
		<script th:src="@{js/stage.js}"></script>
		<script th:src="@{js/main.js}"></script>
		<style type="text/css">
			#canvasDiv canvas{
				position:absolute;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<head><h3>操作说明：玩家1：wasd上左下右，space射击；玩家2：方向键，enter射击。n下一关，p上一关。</h3></head>
			<div class="main clearfix">
				<div id="canvasDiv" style="float: left;">
					<canvas id="wallCanvas" ></canvas> 
					<canvas id="tankCanvas" ></canvas>
					<canvas id="grassCanvas" ></canvas>
					<canvas id="overCanvas" ></canvas> 
					<canvas id="stageCanvas" ></canvas>
				</div>
				<div style="float: left;border:2px solid #F00;width: 30%;height: 446px;overflow:auto;position:relative;">
					<ul style="list-style: none;" id="msgBox_ul">

					</ul>
					<div style="border:5px solid #fdff09;width: 98%;height: 100px;overflow:auto;position:absolute;bottom: 0">
						<textarea style="width: 85%;height: 90%;" id="customerMsg_textarea"></textarea>
						<button style="width: 13%;height: 95%;float: right;">发送</button>
					</div>
				</div>
				<div style="float: left;border:2px solid #F00;width: 12%;height: 446px;overflow:auto;">
					<ul style="list-style: none;" id="onlineList_ul">
					</ul>
				</div>
			</div>
		</div><!-- /container -->

		<script th:src="@{js/ws/sockjs.min.js}"></script>
		<script th:src="@{js/ws/stomp.min.js}"></script>
		<script th:src="@{js/jquery/jquery.js}"></script>
		<script th:src="@{js/supp.js}"></script>
		<script type="text/javascript">

			$(function () {
                connect();
            });

            $(document).keydown(function(e){
                if(e.keyCode == keyboard.ENTER){
                    $("#customerMsg_textarea").val("")//清空
                    sendMessage();
				}
			});

            var stompClient = null;
            function setConnected(connected) {
                //document.getElementById("connect").disabled = connected;
                //document.getElementById("disconnect").disabled = !connected;
                //document.getElementById("conversationDiv").style.visibility=connected?'visible':'hidden';
                //$("#response").html();

            }
            function connect(){

                var userName = null;
                while(userName==null || userName==''){
                    userName = prompt("请输入你的名字 , 我们将为你注册且登录:");
                }

                $.ajax({
                    url:'/login',
                    data: {
                        'userName':userName,
                        'password':'222'
                    },
                    type:'post',
                    dataType:'json',
                    success : function (data) {
                        //var obj = JSON.parse(data);
                        //var dataObj=eval("("+data+")");
                        if(data.userName !=undefined){
                            var socket = new SockJS('/endpointWisely');
                            stompClient = Stomp.over(socket);
                            stompClient.connect({},function (frame) {
                                setConnected(true);
                                console.log("Connected : "+frame);

                                addMsgBox("你 潇洒的上线了","standard");
                                getOnlineUsers();//连接成功获取在线列表

                                stompClient.subscribe('/topic/getResponse',function (response) {
                                    var data = JSON.parse(response.body);
                                    var msgType = data.messageType;

                                    switch (msgType){
										case "PAGE_ONLINE_USERLIST":
                                            var message = data.message;
                                            message =JSON.parse(message);
                                            onLineListUpdate(message.onlineUsers);
										    break;
										case "PAGE_USER_ONLINE_NOTIFY":
                                            var message = data.message;
                                            message =JSON.parse(message);//要把字符串转为JSON对象
											var who = message.userName;
                                        	addMsgBox(who+" 现在上线了","standard");
                                        	//在线列表用户变化 , 重新更新
											setTimeout(function(){
                                                getOnlineUsers();
											},1000);

										    break;
										case "PAGE_USER_OFFLINE_NOTIFY":
                                            var message = data.message;
                                            message =JSON.parse(message);
                                            var who = message.userName;
                                            addMsgBox(who+" 下线回家了","standard");
                                            //在线列表用户变化 , 重新更新
                                            setTimeout(function(){
                                                getOnlineUsers();
                                            },1000);
                                            break;
										default :
										    break;
									}
                                });
                            });
                        }
                    }
                });
            }
            function disconnect(){
                if(stompClient!=null){
                    stompClient.disconnect();
                }
                setConnected(false);
                console.log("Disconnected");
            }


            function onLineListUpdate(onLineUsers) {
                $("#onlineList_ul").empty();
                for(var i =0; onLineUsers.length>i;i++){
					var user = onLineUsers[i];
					var color = getRandomColorCustomer();
                    var appendHtml = '<li style="color: #333333;background-color: '+color+';">'+user.userName+' ● 在线</li>';
                    $("#onlineList_ul").append(appendHtml);
				}
            }
            
            function addMsgBox(data,msgType){
                var appendHtml = "";
				if(msgType=="standard"){
                    var color = getRandomColorCustomer();
                    appendHtml = '<li style="color: #333333;background-color: '+color+';">'+data+'</li>';
                    $("#msgBox_ul").append(appendHtml);
				}
				if(msgType=="error"){
                    var timestamp=new Date().getTime();
                    appendHtml = '<li id="errorMsg_'+timestamp+'" style="color: #FF0000;background-color: '+color+';">错误 : '+data+'</li>';
                    $("#msgBox_ul").append(appendHtml);
                    $("#errorMsg_"+timestamp).hide(4200);
                    //$("#errorMsg_"+timestamp).remove();
				}

			}

			function sendMessage(){
               var customerMsg = $("#customerMsg_textarea").val();

               if(customerMsg.trim()=='' || customerMsg==null){
                   addMsgBox("不可以发空消息...","error");
			   }else{
                   stompClient.send("/getOnlinePlayer",{},JSON.stringify({'name':name}));
			   }
               // $("#customerMsg_textarea").val("")//清空
			}

            function getOnlineUsers() {
                stompClient.send("/getOnlinePlayer",{},null);
            }
		</script>
	</body>
</html>